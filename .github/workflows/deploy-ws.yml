name: Deploy WebSocket Service

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'Dockerfile'
      - 'docker-compose.yml'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - '.github/workflows/deploy-ws.yml'
  workflow_dispatch:

jobs:
  deploy-ws:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VM
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          timeout: 6h
          command_timeout: 360m
          script: |
            set -e
            
            echo "ðŸš€ Starting WebSocket service deployment..."
            cd ~/oms-ws
            
            # Verify we're in the right repository
            echo "ðŸ“‹ Current repository:"
            git remote -v
            
            # Pull latest code from the repository
            echo "ðŸ“¥ Pulling latest code..."
            git pull origin main || git fetch origin main && git reset --hard origin/main
            
            # Create .env file with secrets from GitHub
            echo "ðŸ”§ Setting up environment variables (.env)..."
            cat > .env << EOF
            NODE_ENV=production
            WS_PORT=${{ secrets.WS_PORT || '8080' }}
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY || secrets.GOOGLE_GENERATIVE_AI_API_KEY }}
            OUTREACH_API_URL=${{ secrets.OUTREACH_API_URL }}
            EOF
            
            # Stop existing backend-ws container gracefully
            echo "ðŸ›‘ Stopping existing backend-ws container..."
            docker compose down backend-ws --timeout 30 || true
            
            # Force remove if needed
            echo "ðŸ§¹ Cleaning up any remaining containers..."
            docker compose rm -f backend-ws || true
            
            # Wait a moment
            sleep 3
            
            # Build and start only backend-ws service
            echo "ðŸ”¨ Building backend-ws container..."
            docker compose build backend-ws
            
            echo "ðŸš€ Starting backend-ws container..."
            docker compose up -d backend-ws
            
            # Wait for service to be ready
            echo "â³ Waiting for WebSocket service to start..."
            sleep 15
            
            # Health check (check if container is running)
            echo "ðŸ¥ Performing health check..."
            if docker compose ps backend-ws | grep -q "Up"; then
              echo "âœ… WebSocket service container is running!"
            else
              echo "âŒ Health check failed - container not running"
              echo "ðŸ“‹ Container status:"
              docker compose ps backend-ws
              echo "ðŸ“‹ Container logs:"
              docker compose logs backend-ws --tail=50
              exit 1
            fi
            
            # Clean up unused images
            echo "ðŸ§¹ Cleaning up unused Docker images..."
            docker image prune -f || true
            
            # Show deployment status
            echo "ðŸ“Š Deployment Status:"
            docker compose ps backend-ws
            
            echo "âœ… WebSocket service deployment successful!"
            echo "ðŸ“‹ Repository: $(git config --get remote.origin.url)"
            echo "ðŸ“‹ Latest commit: $(git log -1 --oneline)"

      - name: Rollback on failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          timeout: 6h
          command_timeout: 360m
          script: |
            echo "ðŸ”„ Starting rollback process..."
            cd ~/oms-ws
            
            # Get the previous commit
            PREVIOUS_COMMIT=$(git log -2 --oneline | tail -1 | cut -d' ' -f1)
            echo "ðŸ”„ Rolling back to commit: $PREVIOUS_COMMIT"
            
            # Reset to previous commit
            git reset --hard $PREVIOUS_COMMIT
            
            # Rebuild and restart
            docker compose build backend-ws --no-cache
            docker compose up -d backend-ws
            
            # Wait and check health
            sleep 15
            if docker compose ps backend-ws | grep -q "Up"; then
              echo "âœ… Rollback successful!"
            else
              echo "âŒ Rollback failed - manual intervention required"
              exit 1
            fi


